-- è´Ÿè´£å¤„ç†ç‰©å“çš„å¢åˆ æ”¹æŸ¥

local ItemData = require("Data.ItemData")

local InventoryManager = {}

-- é™æ€å˜é‡
InventoryManager.MaxSlots = 30				-- èƒŒåŒ…æ€»æ ¼å­æ•°
InventoryManager.Slots = {}					-- èƒŒåŒ…æ•°æ® (Model): key = ç´¢å¼•(1åˆ°30), value = ItemDataå®ä¾‹
local weaponUIDCounter = 10000    			-- æ¨¡æ‹ŸæœåŠ¡å™¨å‘æ”¾çš„å…¨å±€å”¯ä¸€ ID ç”Ÿæˆå™¨

-- åˆå§‹åŒ–èƒŒåŒ…
function InventoryManager.Init()
	for i = 1, InventoryManager.MaxSlots do
		InventoryManager.Slots[i] = nil
	end
	print("[InventoryManager] Initialized with", InventoryManager.MaxSlots, "slots.")
end

-- æ·»åŠ ç‰©å“ (è€ƒè™‘å †å )
-- è¿”å›å€¼: æˆåŠŸæ·»åŠ çš„æ•°é‡ (å¯èƒ½å› ä¸ºèƒŒåŒ…æ»¡äº†åªè£…ä¸‹ä¸€éƒ¨åˆ†)
function InventoryManager.AddItem(_configID, _count)
	local config = require("Config.Config_Item")[_configID]
	if not config then
		return 0
	end

	local leftCount = _count

	-- å¦‚æœæ˜¯å¯å †å ç‰©å“ï¼Œå…ˆæ‰¾æœ‰æ²¡æœ‰æ²¡è£…æ»¡çš„åŒç±»æ ¼å­
	if config.MaxStack > 1 then
		for i = 1, InventoryManager.MaxSlots do
			local item = InventoryManager.Slots[i]
			if item and item.ConfigID == _configID and item.Count < config.MaxStack then
				local leftSpace = config.MaxStack - item.Count 		-- å½“å‰æ ¼å­è¿˜èƒ½è£…å¤šå°‘
				if leftCount <= leftSpace then
					item.Count = item.Count + leftCount
					return _count 		-- å…¨éƒ¨å­˜å…¥
				else
					item.Count = config.MaxStack			-- å¡«æ»¡è¿™ä¸ªæ ¼å­
					leftCount = leftCount - leftSpace		-- å‰©ä¸‹çš„ç»§ç»­æ‰¾ä¸‹ä¸€ä¸ªæ ¼å­
				end
			end
		end
	end

	-- å¦‚æœè¿˜æœ‰å‰©ä½™ï¼Œæˆ–è€…æ˜¯ä¸é‡å ç‰©å“ï¼ˆæ­¦å™¨ï¼‰ï¼Œæ‰¾ç©ºæ ¼å­æ”¾
	while leftCount > 0 do
		local isEmptySlotIndex = InventoryManager.GetFirstEmptySlot()
		if isEmptySlotIndex == -1 then
			print(string.format("[Inventory] è­¦å‘Šï¼šèƒŒåŒ…å·²æ»¡ï¼%d ä¸ª %s è¢«ä¸¢å¼ƒã€‚", leftCount, config.Name))
			break
		end

		local addCount = math.min(leftCount, config.MaxStack)

		-- ç”Ÿæˆ UID (æ­¦å™¨ç»™å”¯ä¸€IDï¼Œææ–™ç»™0)
        local uid = 0
        if config.Type == 1 then
            weaponUIDCounter = weaponUIDCounter + 1
            uid = weaponUIDCounter
        end

		InventoryManager.Slots[isEmptySlotIndex] = ItemData.New(_configID, addCount, uid)
		leftCount = leftCount - addCount
	end

	-- TODO: è§¦å‘äº‹ä»¶é€šçŸ¥ UI åˆ·æ–°
    -- EventManager.Fire("OnInventoryChanged")

    local actualAdded = _count - leftCount
    print(string.format("[Inventory] æˆåŠŸæ·»åŠ  %d ä¸ª %s", actualAdded, config.Name))
    return actualAdded
end

-- å¯»æ‰¾ç¬¬ä¸€ä¸ªç©ºæ ¼å­
function InventoryManager.GetFirstEmptySlot()
	for i = 1, InventoryManager.MaxSlots do
		if InventoryManager.Slots[i] == nil then
			return i
		end
	end

	return -1		-- èƒŒåŒ…å·²æ»¡
end

-- æ‰£é™¤ç‰©å“
function InventoryManager.ConsumeItem(_configID, _count)
	local currentTotal = InventoryManager.GetItemCount(_configID)
	if currentTotal < _count then
		print(string.format("[Inventory] æ‰£é™¤å¤±è´¥ï¼š[%d] æ•°é‡ä¸è¶³ (æ‹¥æœ‰:%d, éœ€è¦:%d)", _configId, currentTotal, count))
        return false
    end

    local needToConsume = _count
    for i = 1, InventoryManager.MaxSlots do
    	local item = InventoryManager.Slots[i]
    	if item and item.ConfigID == _configID then
    		if item.Count >= needToConsume then
    			item.Count = item.Count - needToConsume
    			if item.Count == 0 then
    				InventoryManager.Slots[i] = nil
    			end
    			-- TODO: è§¦å‘ UI åˆ·æ–°
    			return true
    		else
    			needToConsume = needToConsume - item.Count
    			InventoryManager.Slots[i] = nil
    		end
    	end
    end

    return false
end

-- è·å–æŸç‰©å“æ€»æ•°
function InventoryManager.GetItemCount(_configID)
	local total = 0
	for i = 1, InventoryManager.MaxSlots do
		local item = InventoryManager.Slots[i]
		if item and item.ConfigID == _configID then
			total = total + item.Count
		end
	end

	return total
end

-- Debug: æ‰“å°èƒŒåŒ…å†…å®¹
function InventoryManager.PrintInventory()
	print("\n=============== ğŸ’ å½“å‰èƒŒåŒ…çŠ¶æ€ ===============")
	local isEmpty = true

	for i = 1, InventoryManager.MaxSlots do
		if InventoryManager.Slots[i] ~= nil then
			print(string.format("æ ¼å­[%02d]: %s", i, InventoryManager.Slots[i]:ToString()))
			isEmpty = false
		end
	end

	if isEmpty then
		print("èƒŒåŒ…æ˜¯ç©ºçš„")
	end
	print("===============================================\n")
end

return InventoryManager